{% extends "base.html" %}
{% block content %}
<div class="card download-card">
  <div class="download-header">
    <div class="download-icon-wrapper">
      <span class="download-icon">üì•</span>
    </div>
    <h2>T√©l√©chargement</h2>
    <p class="muted">Convertissez vos vid√©os YouTube pr√©f√©r√©es en MP3 ou MP4</p>
  </div>
  
  <form method="post" id="downloadForm">
    <div class="form-group url-input-group">
      <label class="form-label">üîó Lien YouTube</label>
      <div class="input-with-button">
        <input type="text" name="url" id="urlInput" placeholder="https://www.youtube.com/watch?v=..." required>
        <button type="button" id="pasteBtn" class="paste-btn" title="Coller l'URL">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
          <span class="paste-text">Coller</span>
        </button>
      </div>
      <p class="form-hint">Collez l'URL compl√®te de la vid√©o YouTube</p>
    </div>
    
    <div class="form-group">
      <label class="form-label">üì¶ Format de sortie</label>
      <div class="format-selector">
        <label class="format-option" data-mode="mp3">
          <input type="radio" name="mode" value="mp3" checked>
          <div class="format-card selected">
            <div class="format-icon-wrapper audio">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 18V5l12-2v13"></path>
                <circle cx="6" cy="18" r="3"></circle>
                <circle cx="18" cy="16" r="3"></circle>
              </svg>
            </div>
            <div class="format-details">
              <span class="format-name">MP3</span>
              <span class="format-type">Audio uniquement</span>
            </div>
            <div class="format-badge audio">üéµ</div>
            <div class="format-check">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
            </div>
          </div>
        </label>
        <label class="format-option" data-mode="mp4">
          <input type="radio" name="mode" value="mp4">
          <div class="format-card">
            <div class="format-icon-wrapper video">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"></rect>
                <line x1="7" y1="2" x2="7" y2="22"></line>
                <line x1="17" y1="2" x2="17" y2="22"></line>
                <line x1="2" y1="12" x2="22" y2="12"></line>
                <line x1="2" y1="7" x2="7" y2="7"></line>
                <line x1="2" y1="17" x2="7" y2="17"></line>
                <line x1="17" y1="17" x2="22" y2="17"></line>
                <line x1="17" y1="7" x2="22" y2="7"></line>
              </svg>
            </div>
            <div class="format-details">
              <span class="format-name">MP4</span>
              <span class="format-type">Audio + Vid√©o</span>
            </div>
            <div class="format-badge video">üé•</div>
            <div class="format-check">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
            </div>
          </div>
        </label>
      </div>
    </div>
    
    <button type="submit" id="downloadBtn" class="download-submit-btn">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="7 10 12 15 17 10"></polyline>
        <line x1="12" y1="15" x2="12" y2="3"></line>
      </svg>
      <span>T√©l√©charger</span>
      <span class="credit-badge">1 cr√©dit</span>
    </button>
  </form>
  
  <!-- Progress indicator (hidden by default) -->
  <div id="progressContainer" class="progress-container" style="display:none;">
    <div class="progress-card">
      <div class="progress-header">
        <div class="progress-spinner"></div>
        <div class="progress-info">
          <span class="progress-title" id="progressText">Initialisation...</span>
          <span class="progress-subtitle" id="progressSubtext">Veuillez patienter</span>
        </div>
        <span class="progress-percent" id="progressPercent">0%</span>
      </div>
      
      <div class="progress-bar-wrapper">
        <div class="progress-bar-track">
          <div class="progress-bar-fill" id="progressBar"></div>
        </div>
      </div>
      
      <div class="progress-steps">
        <div class="progress-step active" id="stage1">
          <div class="step-indicator">
            <svg class="step-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <div class="step-line"></div>
          </div>
          <span class="step-label">Analyse</span>
        </div>
        <div class="progress-step" id="stage2">
          <div class="step-indicator">
            <svg class="step-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            <div class="step-line"></div>
          </div>
          <span class="step-label">T√©l√©chargement</span>
        </div>
        <div class="progress-step" id="stage3">
          <div class="step-indicator">
            <svg class="step-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="23 4 23 10 17 10"></polyline>
              <polyline points="1 20 1 14 7 14"></polyline>
              <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
            </svg>
            <div class="step-line"></div>
          </div>
          <span class="step-label">Conversion</span>
        </div>
        <div class="progress-step" id="stage4">
          <div class="step-indicator">
            <svg class="step-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
          </div>
          <span class="step-label">Termin√©</span>
        </div>
      </div>
    </div>
  </div>
  
  {% if msg %}<div class="error-message">‚ö†Ô∏è {{ msg }}</div>{% endif %}
  
  {% if download_info %}
  <div class="download-result">
    <div class="result-header">
      <div class="result-icon">‚úÖ</div>
      <h3>T√©l√©chargement termin√©</h3>
    </div>
    <div class="result-grid">
      <div class="result-item">
        <span class="result-label">üìπ Titre</span>
        <span class="result-value">{{ download_info.title }}</span>
      </div>
      <div class="result-item">
        <span class="result-label">üë§ Cha√Æne</span>
        <span class="result-value">{{ download_info.uploader }}</span>
      </div>
      <div class="result-item">
        <span class="result-label">‚è±Ô∏è Dur√©e</span>
        <span class="result-value">{{ download_info.duration_str }}</span>
      </div>
      <div class="result-item">
        <span class="result-label">üëÅÔ∏è Vues</span>
        <span class="result-value">{{ download_info.views_str }}</span>
      </div>
      {% if download_info.resolution %}
      <div class="result-item">
        <span class="result-label">üì∫ R√©solution</span>
        <span class="result-value">{{ download_info.resolution }}</span>
      </div>
      {% endif %}
      {% if download_info.filesize_str %}
      <div class="result-item">
        <span class="result-label">üìÅ Taille</span>
        <span class="result-value">{{ download_info.filesize_str }}</span>
      </div>
      {% endif %}
    </div>
  </div>
  {% endif %}
  
  <p class="download-footer">
    <span class="footer-icon">üí°</span>
    <span>Les t√©l√©chargements peuvent prendre quelques minutes selon la taille du fichier.</span>
  </p>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const formatOptions = document.querySelectorAll('.format-option');
  const form = document.getElementById('downloadForm');
  const downloadBtn = document.getElementById('downloadBtn');
  const progressContainer = document.getElementById('progressContainer');
  const progressBar = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');
  const progressSubtext = document.getElementById('progressSubtext');
  const progressPercent = document.getElementById('progressPercent');
  const pasteBtn = document.getElementById('pasteBtn');
  const urlInput = document.getElementById('urlInput');
  
  // Paste URL button
  pasteBtn.addEventListener('click', async function() {
    try {
      const text = await navigator.clipboard.readText();
      urlInput.value = text;
      urlInput.focus();
      pasteBtn.classList.add('pasted');
      setTimeout(() => pasteBtn.classList.remove('pasted'), 1000);
    } catch (err) {
      // Fallback for browsers that don't support clipboard API
      urlInput.focus();
      document.execCommand('paste');
    }
  });
  
  // Format option selection
  formatOptions.forEach(function(option) {
    option.addEventListener('click', function() {
      formatOptions.forEach(function(o) {
        o.querySelector('.format-card').classList.remove('selected');
      });
      option.querySelector('.format-card').classList.add('selected');
    });
  });
  
  // Progress stages with more details
  const stages = [
    { id: 'stage1', text: 'Analyse de la vid√©o', subtext: 'Extraction des m√©tadonn√©es...', percent: 15 },
    { id: 'stage2', text: 'T√©l√©chargement', subtext: 'R√©cup√©ration du contenu...', percent: 50 },
    { id: 'stage3', text: 'Conversion', subtext: 'Traitement du fichier...', percent: 80 },
    { id: 'stage4', text: 'Finalisation', subtext: 'Pr√©paration du fichier...', percent: 95 }
  ];
  
  let currentStage = 0;
  let progressInterval;
  
  function updateProgress() {
    if (currentStage < stages.length) {
      const stage = stages[currentStage];
      document.querySelectorAll('.progress-step').forEach((s, i) => {
        if (i < currentStage) s.classList.add('completed');
        if (i === currentStage) s.classList.add('active');
      });
      progressText.textContent = stage.text;
      progressSubtext.textContent = stage.subtext;
      progressBar.style.width = stage.percent + '%';
      progressPercent.textContent = stage.percent + '%';
      currentStage++;
    } else {
      clearInterval(progressInterval);
    }
  }
  
  // Form submission
  form.addEventListener('submit', function() {
    downloadBtn.disabled = true;
    downloadBtn.innerHTML = '<span class="btn-spinner"></span> Traitement...';
    progressContainer.style.display = 'block';
    
    document.querySelectorAll('.progress-step').forEach(s => {
      s.classList.remove('active', 'completed');
    });
    currentStage = 0;
    progressBar.style.width = '0%';
    
    updateProgress();
    progressInterval = setInterval(function() {
      if (currentStage < stages.length) {
        updateProgress();
      }
    }, 2500);
  });
});
</script>
{% endblock %}